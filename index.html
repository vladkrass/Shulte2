<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Шульте Таблица</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background: #f5f5f5; text-align: center; }
        .controls { margin: 10px 0; }
        .board { display: inline-block; margin-top: 20px; }
        .cell {
            display: inline-block;
            width: 50px; height: 50px; margin: 2px;
            background: #fff; border: 1px solid #ccc; font-size: 20px;
            line-height: 50px; cursor: pointer; user-select: none;
            transition: background 0.2s;
        }
        .cell.found { background: #b3e5fc; }
        #timer, #record { margin: 10px; font-size: 18px; }
    </style>
</head>
<body>
    <h2>Шульте Таблица</h2>
    <div class="controls">
        Размер таблицы:
        <select id="size">
            <option value="4">4x4</option>
            <option value="5">5x5</option>
            <option value="6">6x6</option>
        </select>
        &nbsp;&nbsp;
        Уровень:
        <select id="level">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
        </select>
        &nbsp;&nbsp;
        <button onclick="startGame()">Начать</button>
    </div>
    <div id="timer">Время: 0.0 сек</div>
    <div id="record">Рекорд: -</div>
    <div class="board" id="board"></div>
    <div id="result" style="margin:15px; font-size:20px; color:green;"></div>

    <script>
        let size = 4, level = 1, numbers = [], next = 1;
        let startTime = 0, timerInterval = null, currentTime = 0;
        let bestTime = null;

        function shuffle(arr) {
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
        }

        function startGame() {
            size = parseInt(document.getElementById('size').value);
            level = parseInt(document.getElementById('level').value);
            const n = size * size;
            numbers = [];
            for (let i = 1; i <= n; i++) numbers.push(i);
            shuffle(numbers);
            next = 1;
            drawBoard();
            document.getElementById('result').textContent = "";
            startTime = Date.now();
            currentTime = 0;
            updateTimer();
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(updateTimer, 100);
        }

        function drawBoard() {
            const board = document.getElementById('board');
            board.innerHTML = '';
            for (let i = 0; i < numbers.length; i++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.textContent = numbers[i];
                cell.onclick = function() { clickCell(cell, numbers[i]); };
                board.appendChild(cell);
                if ((i + 1) % size === 0) board.appendChild(document.createElement('br'));
            }
        }

        function clickCell(cell, num) {
            if (num === next) {
                cell.classList.add('found');
                next++;
                if (next > size * size) finishGame();
            }
        }

        function updateTimer() {
            if (next > size * size) return;
            currentTime = (Date.now() - startTime) / 1000;
            document.getElementById('timer').textContent = "Время: " + currentTime.toFixed(1) + " сек";
        }

        function finishGame() {
            if (timerInterval) clearInterval(timerInterval);
            document.getElementById('result').textContent = "Поздравляем! Ваше время: " + currentTime.toFixed(1) + " сек";
            updateRecord(currentTime);
            // --- ВСТАВЛЕНО ДЛЯ TELEGRAM WEBAPP ---
            if (window.Telegram && Telegram.WebApp) {
                Telegram.WebApp.sendData(currentTime.toFixed(1));
                Telegram.WebApp.close();
            }
            // --- КОНЕЦ ДОБАВЛЕНИЯ ---
        }

        function updateRecord(time) {
            let key = "shulte_record_" + size + "x" + size + "_lvl" + level;
            let rec = localStorage.getItem(key);
            if (!rec || time < parseFloat(rec)) {
                localStorage.setItem(key, time);
                bestTime = time;
            } else {
                bestTime = parseFloat(rec);
            }
            document.getElementById('record').textContent = "Рекорд: " + (bestTime ? bestTime.toFixed(1) + " сек" : "-");
        }

        // При запуске показываем рекорд для выбранных настроек
        document.getElementById('size').onchange = document.getElementById('level').onchange = function() {
            let key = "shulte_record_" + document.getElementById('size').value + "x" + document.getElementById('size').value + "_lvl" + document.getElementById('level').value;
            let rec = localStorage.getItem(key);
            document.getElementById('record').textContent = "Рекорд: " + (rec ? parseFloat(rec).toFixed(1) + " сек" : "-");
        };
        // Инициализация рекорда при загрузке
        window.onload = function() {
            let key = "shulte_record_" + document.getElementById('size').value + "x" + document.getElementById('size').value + "_lvl" + document.getElementById('level').value;
            let rec = localStorage.getItem(key);
            document.getElementById('record').textContent = "Рекорд: " + (rec ? parseFloat(rec).toFixed(1) + " сек" : "-");
        };
    </script>
</body>
</html>


